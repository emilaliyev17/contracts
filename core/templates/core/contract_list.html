{% extends 'core/base.html' %}
{% load humanize %}

{% block title %}Contracts - Contract Analyzer{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
.gradient-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.metric-card-new {
  transition: all 0.2s ease;
  cursor: pointer;
}
.metric-card-new:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.15);
}
</style>

<div class="min-h-screen bg-gray-50">
  <!-- Header with Gradient -->
  <div class="gradient-header text-white">
    <div class="container mx-auto px-6 py-12">
      <!-- Main Navigation -->
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-bold">Contract Portfolio</h1>
        <nav class="flex flex-wrap gap-4">
          <a href="{% url 'core:home' %}" class="text-white/80 hover:text-white transition-colors">Home</a>
          <a href="{% url 'core:contract_list' %}" class="text-white font-medium">Contracts</a>
          <a href="{% url 'core:forecast' %}" class="text-white/80 hover:text-white transition-colors">Forecast</a>
          <a href="/admin/" class="text-white/80 hover:text-white transition-colors">Admin</a>
          <a href="{% url 'core:home' %}" class="text-white/80 hover:text-white transition-colors px-4 py-2 bg-white/10 rounded-md hover:bg-white/20">
            Upload Contract
          </a>
        </nav>
      </div>
      
      <p class="text-lg text-white/80 mb-4">Monitor contract processing progress and clarify outstanding items</p>
      
      <!-- Tab Navigation -->
      <div class="flex space-x-1 bg-white/10 rounded-lg p-1 w-fit">
        <a href="?status=all" class="px-4 py-2 rounded-md text-sm font-medium {% if active_filter == 'all' %}bg-white text-purple-600 shadow-sm{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %}">All</a>
        <a href="?status=needs_review" class="px-4 py-2 rounded-md text-sm font-medium {% if active_filter == 'needs_review' %}bg-white text-purple-600 shadow-sm{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %}">Needs Review</a>
        <a href="?status=completed" class="px-4 py-2 rounded-md text-sm font-medium {% if active_filter == 'completed' %}bg-white text-purple-600 shadow-sm{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %}">Completed</a>
        <a href="?status=processing" class="px-4 py-2 rounded-md text-sm font-medium {% if active_filter == 'processing' %}bg-white text-purple-600 shadow-sm{% else %}text-white/80 hover:text-white hover:bg-white/10{% endif %}">Processing</a>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-6 py-8">
    <!-- Metrics Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow-sm p-6 metric-card-new">
        <p class="text-sm text-gray-500">Total Contracts</p>
        <p class="text-3xl font-bold mt-1">{{ summary.total_contracts }}</p>
        <p class="text-sm text-gray-500 mt-1">Active in portfolio</p>
      </div>
      
      <div class="bg-white rounded-lg shadow-sm p-6 metric-card-new">
        <p class="text-sm text-gray-500">Needs Clarification</p>
        <p class="text-3xl font-bold text-yellow-500 mt-1">{{ summary.needs_clarification }}</p>
        <p class="text-sm text-gray-500 mt-1">Pending review</p>
      </div>
      
      <div class="bg-white rounded-lg shadow-sm p-6 metric-card-new">
        <p class="text-sm text-gray-500">Total Contract Value</p>
        <p class="text-3xl font-bold text-blue-500 mt-1">${{ summary.total_value|floatformat:0|intcomma }}</p>
        <p class="text-sm text-gray-500 mt-1">Combined value</p>
      </div>
      
      <div class="bg-white rounded-lg shadow-sm p-6 metric-card-new">
        <p class="text-sm text-gray-500">Completed This Month</p>
        <p class="text-3xl font-bold text-green-500 mt-1">{{ summary.completed_this_month }}</p>
        <p class="text-sm text-gray-500 mt-1">Successfully processed</p>
      </div>
    </div>

    <!-- Existing Content Container -->
    <div class="contracts-page container-fluid px-4">
<style>
/* Override base template container to use full width */
.container {
    max-width: none !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* Compact Metric Cards Styling */
.container-fluid .metric-card {
    background: #f8f9fa !important;
    border-radius: 8px !important;
    padding: 1rem !important;
    border: 1px solid #dee2e6 !important;
    transition: all 0.2s ease;
    cursor: pointer;
}
.container-fluid .metric-card:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}
.container-fluid .metric-card.warning {
    background: #fff3cd !important;
    border-color: #ffc107 !important;
}
.container-fluid .metric-card.info {
    background: #d1ecf1 !important;
    border-color: #17a2b8 !important;
}
.container-fluid .metric-card.success {
    background: #d4edda !important;
    border-color: #28a745 !important;
}
.container-fluid .metric-label {
    font-size: 0.7rem;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
}
.container-fluid .metric-value {
    font-size: 1.25rem;
    font-weight: bold;
    line-height: 1;
}
.container-fluid .metric-context {
    font-size: 0.75rem;
    color: #6c757d;
}

/* Action Buttons Styling */
.btn-link {
    border: none;
    text-decoration: none;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

.btn-link:hover {
    text-decoration: none;
}

.btn-link:focus {
    box-shadow: none;
}

/* Resizable Table Columns */
.contracts-table {
    table-layout: fixed;
    width: 100%;
}
.contracts-table th {
    position: relative;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.contracts-table td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.contracts-table th:hover {
    overflow: visible;
}
.contracts-table td:hover {
    overflow: visible;
    position: relative;
    z-index: 1;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
    <div class="d-flex align-items-center gap-3 mb-4 p-3 bg-white rounded shadow-sm">
        <span class="text-muted">Export Contracts to Excel:</span>
        <a href="{% url 'core:export_excel' %}" class="btn btn-success btn-sm">
            Export All Contracts
        </a>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="filter-export-btn">
            Filter Export
        </button>
    </div>

    <div id="export-filters" class="export-filters" style="display: none;">
        <h5 class="h6 mb-3">Filter Export Options</h5>
        <form id="filter-form" method="get" action="{% url 'core:export_excel' %}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="date_from" class="form-label">From Date</label>
                    <input type="date" id="date_from" name="date_from" class="form-control">
                </div>
                <div class="filter-group">
                    <label for="date_to" class="form-label">To Date</label>
                    <input type="date" id="date_to" name="date_to" class="form-control">
                </div>
                <div class="filter-group">
                    <label for="status" class="form-label">Status</label>
                    <select id="status" name="status" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="uploaded">Uploaded</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="error">Error</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn btn-success">Export Filtered Results</button>
                <button type="button" class="btn btn-outline-secondary" id="cancel-filter-btn">Cancel</button>
            </div>
        </form>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Contract count info -->
    <div class="mb-4">
        <span class="text-sm text-gray-500">Showing {{ contracts|length }} of {{ summary.total_contracts }} contracts</span>
    </div>

    {% if contracts %}
    <!-- Contracts Table Card -->
    <div class="bg-white rounded-lg shadow-sm">
      <div class="p-6 border-b">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <h2 class="text-xl font-semibold">Contracts</h2>
          <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
            <!-- Search -->
            <div class="relative">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <input type="text" placeholder="Search contracts..." class="pl-10 pr-4 py-2 border rounded-lg w-full sm:w-80">
            </div>
            <!-- Export Button -->
            <a href="{% url 'core:export_excel' %}" class="px-4 py-2 border rounded-lg hover:bg-gray-50 flex items-center gap-2">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
              </svg>
              Export to Excel
            </a>
          </div>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b bg-gray-50/50">
              <th class="text-left p-4 font-medium text-sm">#</th>
              <th class="text-left p-4 font-medium text-sm">Contract Name</th>
              <th class="text-left p-4 font-medium text-sm">Contract Number</th>
              <th class="text-left p-4 font-medium text-sm">Client</th>
              <th class="text-right p-4 font-medium text-sm">Total Value</th>
              <th class="text-left p-4 font-medium text-sm">Status</th>
              <th class="text-left p-4 font-medium text-sm">Start Date</th>
              <th class="text-left p-4 font-medium text-sm">End Date</th>
              <th class="text-center p-4 font-medium text-sm">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for contract in contracts %}
            <tr class="border-b hover:bg-gray-50 transition-colors">
              <td class="p-4 text-sm text-gray-500">{{ forloop.counter|stringformat:"02d" }}</td>
              <td class="p-4">
                <a href="{% url 'core:contract_detail' contract.id %}?next={{ request.get_full_path|urlencode }}" class="font-medium text-sm hover:text-primary">{{ contract.contract_name|default:"—" }}</a>
              </td>
              <td class="p-4">
                <code class="text-xs bg-gray-100 px-2 py-1 rounded font-mono">{{ contract.contract_number }}</code>
              </td>
              <td class="p-4 text-sm">{{ contract.client_name|default:"—" }}</td>
              <td class="p-4 text-right font-medium text-sm">
                {% if contract.total_value %}
                    ${{ contract.total_value|floatformat:0|intcomma }}
                {% else %}
                    <span class="text-gray-400">N/A</span>
                {% endif %}
              </td>
              <td class="p-4">
                {% if contract.status == 'completed' %}
                  <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700 border border-green-200">Completed</span>
                {% elif contract.status == 'needs_clarification' %}
                  <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700 border border-yellow-200">Needs Review</span>
                {% elif contract.status == 'processing' %}
                  <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700 border border-blue-200">Processing</span>
                {% else %}
                  <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700 border border-gray-200">{{ contract.status|title }}</span>
                {% endif %}
              </td>
              <td class="p-4 text-sm text-gray-500">{{ contract.start_date|date:"M d, Y"|default:"—" }}</td>
              <td class="p-4 text-sm text-gray-500">{{ contract.end_date|date:"M d, Y"|default:"—" }}</td>
              <td class="p-4">
                <div class="flex items-center justify-center gap-2">
                  <a href="{% url 'core:contract_detail' contract.id %}?next={{ request.get_full_path|urlencode }}" class="p-1.5 border rounded hover:bg-gray-50" title="View">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                  </a>
                  <form method="post" action="{% url 'core:delete_contract' contract.id %}" style="display: inline;" onsubmit="return confirmDelete('{{ contract.contract_name|escapejs }}', {{ contract.id }});">
                    {% csrf_token %}
                    <button type="submit" class="p-1.5 border rounded hover:bg-red-50 text-red-600" title="Delete">
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow-sm p-12 text-center">
      {% if summary.total_contracts %}
        <h3 class="text-lg font-semibold mb-2">No contracts match this filter</h3>
        <p class="text-gray-500 mb-4">Try selecting a different tab or clear the current filter to view more contracts.</p>
        <a href="{% url 'core:contract_list' %}" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">Clear Filter</a>
      {% else %}
        <h3 class="text-lg font-semibold mb-2">No Contracts Found</h3>
        <p class="text-gray-500 mb-4">Upload a contract to start tracking agreements in this workspace.</p>
        <a href="{% url 'core:home' %}" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">Upload Your First Contract</a>
      {% endif %}
    </div>
    {% endif %}
</div>

<style>
.contracts-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}


.summary-stack {
    width: 100%;
    border-radius: 0.9rem;
    overflow: hidden;
    padding: 0;
}

.summary-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.6rem 1.5rem;
    border-bottom: 1px solid #edf0f6;
    transition: background-color 0.18s ease;
}

.summary-item:hover {
    background-color: #f7f9fe;
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-label {
    font-size: 0.7rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #6c757d;
}

.summary-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: #212529;
}

.export-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.export-btn {
    padding: 0.6rem 1.5rem;
}

.export-filters {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.75rem;
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.filter-group {
    flex: 1 1 220px;
}

.filter-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
}

.nav.contract-filters {
    display: inline-flex;
    flex-wrap: wrap;
    padding: 0;
    background: transparent;
    list-style: none;
    gap: 0.75rem;
    align-items: center;
}

.contract-filters .nav-link {
    border-radius: 999px;
    padding: 0.5rem 1rem;
    color: #6c757d;
    font-weight: 500;
}

.contract-filters .nav-link.active {
    background-color: #0d6efd;
    color: #fff;
    box-shadow: 0 0.25rem 0.75rem rgba(13, 110, 253, 0.15);
}

.contract-filters .nav-link:not(.active):hover {
    background-color: rgba(13, 110, 253, 0.08);
    color: #0d6efd;
}

.contract-link {
    color: #0d6efd;
    text-decoration: none;
    font-weight: 500;
}

.contract-link:hover {
    color: #0a58ca;
    text-decoration: underline;
}

.contract-table {
    min-width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.contract-table thead th {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #6c757d;
    background-color: #f5f7fb;
    border: 0;
    border-bottom: 1px solid #e3e7ef;
    padding: 0.75rem 1rem;
}

.contract-table tbody td {
    padding: 1rem;
    border-top: 0;
    border-bottom: 1px solid #eef1f6;
    vertical-align: middle;
    color: #343a40;
    font-size: 0.95rem;
}

.contract-table tbody tr:last-child td {
    border-bottom: 0;
}

.contract-table tbody tr:hover {
    background-color: #f8f9fc;
}

.status-chip {
    display: inline-flex;
    align-items: center;
    font-weight: 600;
    font-size: 0.9rem;
    letter-spacing: -0.01em;
}

.status-dot {
    width: 0.6rem;
    height: 0.6rem;
    border-radius: 999px;
    display: inline-block;
}

.status-dot-neutral {
    background-color: #ced4da;
}

.status-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.1rem;
    height: 1.1rem;
    border-radius: 999px;
    background-color: rgba(25, 135, 84, 0.1);
}

.status-icon svg {
    width: 0.75rem;
    height: 0.75rem;
}

.dropdown .kebab {
    font-size: 1.25rem;
    line-height: 1;
}

.empty-state {
    border-radius: 0.9rem;
}

.empty-state .card-body {
    max-width: 420px;
    margin: 0 auto;
}

@media (max-width: 576px) {
    .summary-card .card-body {
        padding: 1.25rem;
    }

    .contract-table thead {
        display: none;
    }

    .contract-table tbody td {
        display: block;
        padding: 0.75rem 0.5rem;
        border-bottom: none;
    }

    .contract-table tbody tr {
        border-bottom: 1px solid #eef1f6;
        padding: 0.5rem 0;
    }

    .contract-table tbody td:last-child {
        padding-bottom: 1rem;
    }
}
</style>

<script>
function confirmDelete(contractName, contractId) {
    const message = `Are you sure you want to delete this contract?\n\n` +
                   `Contract: "${contractName}"\n` +
                   `ID: ${contractId}\n\n` +
                   `WARNING: This action cannot be undone.\n` +
                   `This will permanently delete all contract data and payment milestones.`;
    
    return confirm(message);
}

// Export filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterExportBtn = document.getElementById('filter-export-btn');
    const exportFilters = document.getElementById('export-filters');
    const cancelFilterBtn = document.getElementById('cancel-filter-btn');

    if (filterExportBtn) {
        filterExportBtn.addEventListener('click', function() {
            exportFilters.style.display = exportFilters.style.display === 'none' ? 'block' : 'none';
        });
    }

    if (cancelFilterBtn) {
        cancelFilterBtn.addEventListener('click', function() {
            exportFilters.style.display = 'none';
        });
    }

    // Set default date range (last 30 days)
    const dateFromInput = document.getElementById('date_from');
    const dateToInput = document.getElementById('date_to');
    
    if (dateFromInput && dateToInput) {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        dateFromInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        dateToInput.value = today.toISOString().split('T')[0];
    }
});
</script>
    </div> <!-- Close contracts-page -->
  </div> <!-- Close container -->
</div> <!-- Close min-h-screen -->

{% endblock %}
