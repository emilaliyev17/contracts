{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Contract Portfolio - Contract Analyzer{% endblock %}

{% block content %}
<!-- Material Symbols Icons -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

<style>
.geometric-pattern {
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

/* Sticky table headers */
.contracts-table-wrapper thead th {
    position: sticky;
    top: 0;
    z-index: 20;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Hide filter export panel by default */
#export-filters {
    display: none;
}
</style>

<div class="flex flex-col min-h-screen">
    <!-- HEADER with background image and geometric pattern -->
    <header class="w-full text-white relative" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.5), rgba(118, 75, 162, 0.5)), url('{% static 'images/header.png' %}'); background-size: cover; background-position: center;">
        <div class="absolute inset-0 geometric-pattern"></div>
        <div class="relative max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-10">
                <div>
                    <h1 class="text-4xl font-bold">Contract Portfolio</h1>
                    <p class="mt-2 text-white/80">Monitor contract processing progress and clarify outstanding items</p>
                </div>
                <a class="text-sm font-medium hover:underline" href="/admin/">Admin</a>
            </div>
            
            <!-- NAVIGATION TABS with Django URL routing -->
            <div class="bg-white/10 rounded-lg p-1.5 mb-6">
                <nav class="flex space-x-1 overflow-x-auto">
                    <a href="?status=all" class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap {% if active_filter == 'all' %}bg-white text-primary{% else %}text-white/80 hover:bg-white/20{% endif %}">All</a>
                    <a href="?status=needs_review" class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap {% if active_filter == 'needs_review' %}bg-white text-primary{% else %}text-white/80 hover:bg-white/20{% endif %}">Needs Review</a>
                    <a href="?status=completed" class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap {% if active_filter == 'completed' %}bg-white text-primary{% else %}text-white/80 hover:bg-white/20{% endif %}">Completed</a>
                    <a href="?status=processing" class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap {% if active_filter == 'processing' %}bg-white text-primary{% else %}text-white/80 hover:bg-white/20{% endif %}">Processing</a>
                    <a href="{% url 'core:hubspot_sync' %}" class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap text-white/80 hover:bg-white/20">HubSpot Sync</a>
                    <a href="{% url 'core:fpa_dashboard' %}" class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap text-white/80 hover:bg-white/20">FP&A</a>
                    <a href="{% url 'core:accounting' %}" class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap text-white/80 hover:bg-white/20">Accounting</a>
                    <a href="{% url 'core:forecast' %}" class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap text-white/80 hover:bg-white/20">Forecast</a>
                    <a href="{% url 'core:home' %}" class="px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap text-white/80 hover:bg-white/20">Upload</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 w-full py-8">
        <!-- METRIC CARDS with Django variables -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-card dark:bg-dark-card p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow duration-300">
                <p class="text-muted dark:text-dark-muted text-sm font-medium">Total Contracts</p>
                <p class="text-3xl font-bold text-foreground dark:text-dark-foreground mt-2">{{ summary.total_contracts }}</p>
            </div>
            <div class="bg-card dark:bg-dark-card p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow duration-300">
                <p class="text-muted dark:text-dark-muted text-sm font-medium">Needs Clarification</p>
                <p class="text-3xl font-bold text-warning mt-2">{{ summary.needs_clarification }}</p>
            </div>
            <div class="bg-card dark:bg-dark-card p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow duration-300">
                <p class="text-muted dark:text-dark-muted text-sm font-medium">Total Contract Value</p>
                <p class="text-3xl font-bold text-info mt-2">${{ summary.total_value|floatformat:0|intcomma }}</p>
            </div>
            <div class="bg-card dark:bg-dark-card p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow duration-300">
                <p class="text-muted dark:text-dark-muted text-sm font-medium">Completed This Month</p>
                <p class="text-3xl font-bold text-success mt-2">{{ summary.completed_this_month }}</p>
            </div>
        </div>

        <!-- MESSAGES -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- SEARCH and EXPORT BUTTONS -->
        <div class="mt-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <!-- SEARCH BAR with form wrapper -->
            <form method="get" action="{% url 'core:contract_list' %}" class="w-full md:w-[400px]">
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-muted dark:text-dark-muted">search</span>
                    <input name="search" value="{{ search_query }}" class="w-full pl-10 pr-4 py-2 rounded-lg border border-border dark:border-dark-border bg-card dark:bg-dark-card focus:ring-primary focus:border-primary" placeholder="Search contracts, clients, or content..." type="text"/>
                </div>
            </form>
            
            <!-- EXPORT BUTTONS with existing functionality -->
            <div class="flex space-x-4">
                <a href="{% url 'core:export_excel' %}" class="px-4 py-2 text-sm font-semibold text-white bg-success rounded-lg hover:bg-opacity-90">Export All Contracts</a>
                <button type="button" id="filter-export-btn" class="px-4 py-2 text-sm font-semibold text-muted dark:text-dark-muted bg-card dark:bg-dark-card border border-border dark:border-dark-border rounded-lg hover:bg-background dark:hover:bg-dark-card-hover">Filter Export</button>
            </div>
        </div>

        <!-- FILTER EXPORT PANEL -->
        <div id="export-filters" class="mt-4 p-6 bg-card dark:bg-dark-card rounded-lg border border-border dark:border-dark-border shadow-sm">
            <h5 class="text-lg font-semibold mb-4">Filter Export Options</h5>
            <form id="filter-form" method="get" action="{% url 'core:export_excel' %}">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="date_from" class="block text-sm font-medium text-foreground dark:text-dark-foreground mb-2">From Date</label>
                        <input type="date" id="date_from" name="date_from" class="w-full px-3 py-2 border border-border dark:border-dark-border rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="date_to" class="block text-sm font-medium text-foreground dark:text-dark-foreground mb-2">To Date</label>
                        <input type="date" id="date_to" name="date_to" class="w-full px-3 py-2 border border-border dark:border-dark-border rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-foreground dark:text-dark-foreground mb-2">Status</label>
                        <select id="status" name="status" class="w-full px-3 py-2 border border-border dark:border-dark-border rounded-lg focus:ring-primary focus:border-primary">
                            <option value="">All Statuses</option>
                            <option value="uploaded">Uploaded</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-filter-btn" class="px-4 py-2 text-sm font-semibold text-muted dark:text-dark-muted bg-card dark:bg-dark-card border border-border dark:border-dark-border rounded-lg hover:bg-background">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-success rounded-lg hover:bg-opacity-90">Export Filtered Results</button>
                </div>
            </form>
        </div>

        <!-- CONTRACTS TABLE -->
        <div class="mt-8 flow-root">
            <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                    <div class="shadow ring-1 ring-black ring-opacity-5 rounded-lg" style="max-height: 600px; overflow-y: auto; overflow-x: auto;">
                        {% if contracts %}
                        <table class="min-w-full divide-y divide-border dark:divide-dark-border relative">
                            <thead class="bg-white sticky top-0 z-30 shadow-sm">
                                <tr>
                                    <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-foreground dark:text-dark-foreground bg-white sm:pl-6" scope="col">#</th>
                                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-foreground dark:text-dark-foreground bg-white" scope="col">Client</th>
                                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-foreground dark:text-dark-foreground bg-white" scope="col">Contract#</th>
                                    <th class="px-3 py-3.5 text-right text-sm font-semibold text-foreground dark:text-dark-foreground bg-white" scope="col">Total Value</th>
                                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-foreground dark:text-dark-foreground bg-white" scope="col">Status</th>
                                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-foreground dark:text-dark-foreground bg-white" scope="col">Payment Frequency</th>
                                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-foreground dark:text-dark-foreground bg-white" scope="col">Start Date</th>
                                    <th class="px-3 py-3.5 text-left text-sm font-semibold text-foreground dark:text-dark-foreground bg-white" scope="col">End Date</th>
                                    <th class="relative py-3.5 pl-3 pr-4 bg-white sm:pr-6" scope="col">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-border dark:divide-dark-border bg-card dark:bg-dark-card">
                                {% for contract in contracts %}
                                <tr class="{% cycle '' 'bg-background dark:bg-dark-background/20' %} hover:bg-background/80 dark:hover:bg-dark-background/40">
                                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-foreground dark:text-dark-foreground sm:pl-6">{{ forloop.counter|stringformat:"02d" }}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-muted dark:text-dark-muted">{{ contract.client_name|default:"—" }}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-muted dark:text-dark-muted">
                                        <div class="flex items-center">
                                            {% if contract.is_hubspot_matched %}
                                                <span class="h-2 w-2 rounded-full bg-success mr-2" title="Matched with HubSpot"></span>
                                            {% else %}
                                                <span class="h-2 w-2 rounded-full bg-muted dark:bg-dark-muted mr-2" title="Not matched"></span>
                                            {% endif %}
                                            {{ contract.contract_number }}
                                        </div>
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-muted dark:text-dark-muted">
                                        {% if contract.total_value %}
                                            ${{ contract.total_value|floatformat:0|intcomma }}
                                        {% else %}
                                            <span class="text-gray-400">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-muted dark:text-dark-muted">
                                        {% if contract.status == 'completed' %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success/10 text-success">Completed</span>
                                        {% elif contract.status == 'needs_clarification' %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-warning/10 text-warning">Needs Review</span>
                                        {% elif contract.status == 'processing' %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-info/10 text-info">Processing</span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700">{{ contract.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-muted dark:text-dark-muted">
                                        {% if contract.payment_terms %}
                                            {{ contract.payment_terms.get_payment_frequency_display }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-muted dark:text-dark-muted">{{ contract.start_date|date:"M d, Y"|default:"—" }}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-muted dark:text-dark-muted">{{ contract.end_date|date:"M d, Y"|default:"—" }}</td>
                                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6 space-x-2">
                                        <a href="{% url 'core:contract_detail' contract.id %}?next={{ request.get_full_path|urlencode }}" class="text-primary hover:text-opacity-80" title="View">
                                            <span class="material-symbols-outlined text-base">visibility</span>
                                        </a>
                                        <form method="post" action="{% url 'core:delete_contract' contract.id %}" style="display: inline;" onsubmit="return confirmDelete('{{ contract.contract_name|escapejs }}', {{ contract.id }});">
                                            {% csrf_token %}
                                            <button type="submit" class="text-red-500 hover:text-red-700" title="Delete">
                                                <span class="material-symbols-outlined text-base">delete</span>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <!-- EMPTY STATE -->
                        <div class="bg-card dark:bg-dark-card p-12 text-center">
                            {% if summary.total_contracts %}
                                <h3 class="text-lg font-semibold mb-2 text-foreground dark:text-dark-foreground">No contracts match this filter</h3>
                                <p class="text-muted dark:text-dark-muted mb-4">Try selecting a different tab or clear the current filter to view more contracts.</p>
                                <a href="{% url 'core:contract_list' %}" class="inline-block px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">Clear Filter</a>
                            {% else %}
                                <h3 class="text-lg font-semibold mb-2 text-foreground dark:text-dark-foreground">No Contracts Found</h3>
                                <p class="text-muted dark:text-dark-muted mb-4">Upload a contract to start tracking agreements in this workspace.</p>
                                <a href="{% url 'core:home' %}" class="inline-block px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">Upload Your First Contract</a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGINATION with Django variables -->
        <div class="mt-8 flex justify-between items-center">
            <p class="text-sm text-muted dark:text-dark-muted">Showing {{ contracts|length }} of {{ summary.total_contracts }} contracts</p>
            <!-- Pagination controls can be added here if needed -->
        </div>
    </main>
</div>

<!-- PRESERVE ALL JAVASCRIPT FUNCTIONS -->
<script>
// Confirm delete function
function confirmDelete(contractName, contractId) {
    const message = `Are you sure you want to delete this contract?\n\n` +
                   `Contract: "${contractName}"\n` +
                   `ID: ${contractId}\n\n` +
                   `WARNING: This action cannot be undone.\n` +
                   `This will permanently delete all contract data and payment milestones.`;
    
    return confirm(message);
}

// Export filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterExportBtn = document.getElementById('filter-export-btn');
    const exportFilters = document.getElementById('export-filters');
    const cancelFilterBtn = document.getElementById('cancel-filter-btn');

    if (filterExportBtn) {
        filterExportBtn.addEventListener('click', function() {
            exportFilters.style.display = exportFilters.style.display === 'none' ? 'block' : 'none';
        });
    }

    if (cancelFilterBtn) {
        cancelFilterBtn.addEventListener('click', function() {
            exportFilters.style.display = 'none';
        });
    }

    // Set default date range (last 30 days)
    const dateFromInput = document.getElementById('date_from');
    const dateToInput = document.getElementById('date_to');
    
    if (dateFromInput && dateToInput) {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        dateFromInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        dateToInput.value = today.toISOString().split('T')[0];
    }
});
</script>

{% endblock %}