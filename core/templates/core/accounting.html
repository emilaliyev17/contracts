{% extends 'core/base.html' %}
{% block content %}
<div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white">
    <div class="px-4 py-8">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold mb-2">Accounting</h1>
                <p class="text-purple-100">Invoice reconciliation with QuickBooks</p>
            </div>
            <button onclick="history.back()" 
                    class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-colors duration-200">
                Back
            </button>
        </div>
    </div>
</div>

<div class="p-6">
    <div class="flex justify-end mb-4 space-x-2">
        <button id="editBtn" 
                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Edit
        </button>
        <button id="saveBtn" 
                class="px-6 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed" 
                disabled>
            Save
        </button>
    </div>

    <table class="w-full">
        <thead>
            <tr class="border-b bg-gray-50">
                <th class="text-left p-4">Contract Name</th>
                <th class="text-left p-4">Contract Number</th>
                <th class="text-left p-4">Due Date</th>
                <th class="text-left p-4">Invoice#</th>
                <th class="text-right p-4">Amount</th>
                <th class="text-left p-4">QBO Invoice#</th>
                <th class="text-left p-4">QBO Inv Date</th>
                <th class="text-right p-4">QBO Amount</th>
                <th class="text-right p-4">Difference</th>
            </tr>
        </thead>
        <tbody>
            {% for milestone in milestones %}
            <tr class="border-b">
                <td class="p-4">{{ milestone.contract.contract_name }}</td>
                <td class="p-4">{{ milestone.contract.contract_number }}</td>
                <td class="p-4">{{ milestone.due_date|date:"M d, Y" }}</td>
                <td class="p-4">{{ milestone.milestone_name }}</td>
                <td class="p-4 text-right">${{ milestone.amount|floatformat:2 }}</td>
                <td class="p-4">
                    <input type="text" 
                           class="border rounded px-2 py-1 w-32 qbo-input" 
                           value="{{ milestone.qbo_invoice_number|default:'' }}"
                           placeholder="QBO Invoice#"
                           data-milestone-id="{{ milestone.id }}"
                           data-field="qbo_invoice_number"
                           disabled>
                </td>
                <td class="p-4">
                    <input type="date" 
                           class="border rounded px-2 py-1 qbo-input" 
                           value="{{ milestone.qbo_invoice_date|date:'Y-m-d'|default:'' }}"
                           data-milestone-id="{{ milestone.id }}"
                           data-field="qbo_invoice_date"
                           disabled>
                </td>
                <td class="p-4">
                    <input type="number" 
                           step="0.01"
                           class="border rounded px-2 py-1 w-32 text-right qbo-amount qbo-input" 
                           value="{{ milestone.qbo_amount|default:'' }}"
                           placeholder="0.00"
                           data-milestone-id="{{ milestone.id }}"
                           data-field="qbo_amount"
                           data-original-amount="{{ milestone.amount }}"
                           disabled>
                </td>
                <td class="p-4 text-right difference">
                    <span id="diff-{{ milestone.id }}">-</span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
const editBtn = document.getElementById('editBtn');
const saveBtn = document.getElementById('saveBtn');
const inputs = document.querySelectorAll('.qbo-input');

editBtn.addEventListener('click', function() {
    inputs.forEach(input => input.disabled = false);
    editBtn.disabled = true;
    editBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
    editBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    
    saveBtn.disabled = false;
    saveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
    saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
});

saveBtn.addEventListener('click', function() {
    const updates = [];
    inputs.forEach(input => {
        updates.push({
            id: input.dataset.milestoneId,
            field: input.dataset.field,
            value: input.value
        });
    });
    
    fetch("{% url 'core:save_qbo_data' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({updates: updates})
    }).then(() => {
        location.reload();
    });
});

// Keep the difference calculation for QBO amount fields
document.querySelectorAll('.qbo-amount').forEach(input => {
    input.addEventListener('input', function() {
        const milestoneId = this.dataset.milestoneId;
        const originalAmount = parseFloat(this.dataset.originalAmount);
        const qboAmount = parseFloat(this.value) || 0;
        const difference = originalAmount - qboAmount;
        
        const diffElement = document.getElementById('diff-' + milestoneId);
        diffElement.textContent = '$' + difference.toFixed(2);
        
        if (Math.abs(difference) > 0.01) {
            diffElement.style.color = 'red';
        } else {
            diffElement.style.color = 'green';
        }
    });
});
</script>
{% endblock %}
